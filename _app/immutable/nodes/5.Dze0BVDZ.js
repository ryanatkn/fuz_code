import"../chunks/Bzak7iHL.js";import{p as W,f as P,R as _,ad as j,d as g,r as u,b as I,c as Y,a2 as S,P as K,a as V,Q as Ne,s as x,t as q,e as F,ac as k,T as _e,V as Re,aB as Se,ap as Ie,b9 as Ce,a1 as Oe,b2 as Ae}from"../chunks/CriDM97G.js";import{i as H}from"../chunks/Uai6rqm9.js";import{b as Pe,C as Le,e as J,a as ue,f as Fe,r as te,d as De,g as je,s as He}from"../chunks/DiacO5e5.js";import{t as de,s as Be,a as Ue,b as ne}from"../chunks/CffEEp_T.js";import{b as he}from"../chunks/BpUdJ0yi.js";import{C as $e,s as ze}from"../chunks/DLR3bUrt.js";import{p as z,r as ke,s as qe}from"../chunks/22FlD-6z.js";import{k as Ve}from"../chunks/OQJ8eYV1.js";import{c as Qe}from"../chunks/Du6N63M2.js";import{C as Xe}from"../chunks/BemZg9ii.js";var Ge=P("<div>✓</div>"),Ze=P("<div>⧉</div>"),Je=P("<button><!></button>");function Ke(e,n){W(n,!0);const o=z(n,"copied_display_duration",3,1e3),t=z(n,"icon_button",3,!0),l=ke(n,["$$slots","$$events","$$legacy","text","copied_display_duration","allow_copying_empty_string","icon_button","oncopy","disabled","children","class"]);let s=j(!1),a=j(!1),d;const r=async p=>{var m;if(clearTimeout(d),n.text!==null){S(s,!1),S(a,!1);try{await navigator.clipboard.writeText(n.text),S(s,!0)}catch{S(a,!0);return}d=setTimeout(()=>{S(s,!1)},o()),(m=n.oncopy)==null||m.call(n,n.text,p)}};var i=Je();Pe(i,()=>({type:"button",title:"copy to clipboard",...l,class:`copy_to_clipboard ${n.class??""}`,onclick:r,disabled:n.disabled??(n.allow_copying_empty_string?n.text===null:!n.text),[Le]:{icon_button:n.children?!1:t(),copied:_(s),failed:_(a),color_c:_(a)}}));var c=g(i);{var w=p=>{var m=K(),h=V(m);Ne(h,()=>n.children,()=>_(s),()=>_(a)),I(p,m)},b=p=>{var m=K(),h=V(m);{var C=E=>{var T=Ge();de(1,T,()=>Be,()=>({duration:200})),I(E,T)},y=E=>{var T=Ze();de(1,T,()=>Ue),I(E,T)};H(h,E=>{_(s)?E(C):E(y,!1)},!0)}I(p,m)};H(c,p=>{n.children?p(w):p(b,!1)})}u(i),I(e,i),Y()}const We=.25,Ye=.75,pe=1.5,et=3.5,tt=5,ve=.6745,nt=.3,ot=.4,st=.8,rt=.95,at=.99,it=1.96,lt=1e3,ct=3,ie=e=>{const n=Math.floor(e.length/2);return e.length%2===0?(e[n-1]+e[n])/2:e[n]},mt=e=>{if(e.length<ct)return{cleaned_times:e,outliers:[]};const n=[...e].sort((r,i)=>r-i),o=ie(n),l=[...e.map(r=>Math.abs(r-o))].sort((r,i)=>r-i),s=ie(l);if(s===0){const r=n[Math.floor(n.length*We)],i=n[Math.floor(n.length*Ye)],c=i-r;if(c===0)return{cleaned_times:e,outliers:[]};const w=r-pe*c,b=i+pe*c,p=[],m=[];for(const h of e)h<w||h>b?m.push(h):p.push(h);return{cleaned_times:p,outliers:m}}const a=[],d=[];for(const r of e){const i=ve*(r-o)/s;Math.abs(i)>et?d.push(r):a.push(r)}if(d.length>e.length*nt){a.length=0,d.length=0;for(const r of e){const i=ve*(r-o)/s;Math.abs(i)>tt?d.push(r):a.push(r)}if(d.length>e.length*ot){const r=e.map(c=>({time:c,distance:Math.abs(c-o)}));r.sort((c,w)=>c.distance-w.distance);const i=Math.floor(e.length*st);a.length=0,d.length=0;for(let c=0;c<r.length;c++)c<i?a.push(r[c].time):d.push(r[c].time)}}return{cleaned_times:a,outliers:d}},_t=e=>{const n=[];let o=0;for(const v of e.times)!isNaN(v)&&isFinite(v)&&v>0?n.push(v):o++;if(n.length===0)return{mean:NaN,median:NaN,std_dev:NaN,min:NaN,max:NaN,p95:NaN,p99:NaN,cv:NaN,confidence_interval:[NaN,NaN],outliers:0,outlier_ratio:0,sample_size:0,raw_sample_size:e.times.length,stability_ratio:0,unstable_iterations:e.times.length,ops_per_second:0,failed_iterations:o};const{cleaned_times:t,outliers:l}=mt(n),s=[...t].sort((v,N)=>v-N),a=t.reduce((v,N)=>v+N,0)/t.length,d=ie(s),r=t.reduce((v,N)=>v+(N-a)**2,0)/t.length,i=Math.sqrt(r),c=s[0],w=s[s.length-1],b=s[Math.floor(s.length*rt)],p=s[Math.floor(s.length*at)],m=i/a,h=i/Math.sqrt(t.length),C=it*h,y=a-C,E=a+C,T=e.stability_checks.filter(v=>!v.is_stable).length,M=1-T/e.stability_checks.length,O=a>0?lt/a:0;return{mean:a,median:d,std_dev:i,min:c,max:w,p95:b,p99:p,cv:m,confidence_interval:[y,E],outliers:l.length,outlier_ratio:l.length/n.length,sample_size:t.length,raw_sample_size:e.times.length,stability_ratio:M,unstable_iterations:T,ops_per_second:O,failed_iterations:o}},ut=e=>{const n={};for(const l of e)n[l.implementation]||(n[l.implementation]=[]),n[l.implementation].push(l);const o={};for(const[l,s]of Object.entries(n)){const a=s.map(c=>c.mean),d=a.reduce((c,w)=>c+w,0)/a.length,r=s.map(c=>c.ops_per_second).reduce((c,w)=>c+w,0)/s.length,i=s.map(c=>c.cv).reduce((c,w)=>c+w,0)/s.length;o[l]={avg_mean:d,avg_ops:r,avg_cv:i,languages:s.length}}const t=o.html.avg_mean;for(const l of Object.keys(o))o[l].relative_speed=t/o[l].avg_mean,o[l].improvement=(o[l].relative_speed-1)*100;return o},dt=(e,n=.15)=>{const o=[];for(const t of e)t.cv>n&&o.push(`High variance for ${t.implementation}/${t.language}: CV=${(t.cv*100).toFixed(1)}%`);return o},D=(e,n=2)=>e.toFixed(n),oe=[{header:"Language",key:"language",format:e=>e},{header:"Implementation",key:"implementation",format:e=>e},{header:"Mean (ms)",key:"mean",format:e=>D(e)},{header:"Median (ms)",key:"median",format:e=>D(e)},{header:"Std Dev",key:"std_dev",format:e=>D(e)},{header:"CV",key:"cv",format:e=>`${D(e*100,1)}%`,class:e=>e>.15?"warning":""},{header:"P95 (ms)",key:"p95",format:e=>D(e)},{header:"Ops/sec",key:"ops_per_second",format:e=>D(e,0)},{header:"Outliers",key:"outliers",format:(e,n)=>`${e}/${n.raw_sample_size}`,class:(e,n)=>n.outlier_ratio>.1?"warning":""},{header:"Failed",key:"failed_iterations",format:e=>e.toString(),class:e=>e>0?"warning":""},{header:"Stability",key:"stability_ratio",format:e=>`${D(e*100,0)}%`,class:e=>e>.9?"good":""}],pt=e=>{if(e.length===0)return"";const n=oe.map(t=>t.header);let o="| "+n.join(" | ")+` |
`;o+="| "+n.map(()=>"---").join(" | ")+` |
`;for(const t of e){const l=oe.map(s=>s.format(t[s.key],t));o+="| "+l.join(" | ")+` |
`}return o};var vt=P("<li> </li>"),gt=P('<section class="panel p_md warning"><h3 class="mt_0">⚠️ Warnings</h3> <ul></ul></section>'),ht=P("<div><strong> </strong> <span>vs baseline</span></div>"),ft=P("<div><h3> </h3> <div><strong> </strong> <span>avg time</span></div> <div><strong> </strong> <span>ops/sec</span></div> <div><strong> </strong> <span>CV</span></div> <!></div>"),yt=P("<section><h2>Summary</h2> <div></div></section>"),wt=P("<th> </th>"),bt=P("<td> </td>"),Mt=P("<tr></tr>"),xt=P(`<section><h2>Results</h2> <table><thead><tr></tr></thead><tbody></tbody></table> <div class="mt_md"><!></div> <div><h3>Legend</h3> <ul><li><strong>CV</strong>: Coefficient of Variation (std_dev/mean) - lower is better, &lt;15% is
					good</li> <li><strong>P95</strong>: 95th percentile - 95% of measurements were faster than this</li> <li><strong>Ops/sec</strong>: Operations per second (throughput)</li> <li><strong>Per Item</strong>: Time per individual component in batch</li> <li><strong>Stability</strong>: Percentage of iterations with stable system metrics</li></ul></div></section>`),Et=P("<!> <!> <!>",1);function Tt(e,n){W(n,!0);const o=z(n,"results",19,()=>[]),t=z(n,"summary",3,null),l=z(n,"warnings",19,()=>[]);var s=Et(),a=V(s);{var d=b=>{var p=gt(),m=x(g(p),2);J(m,20,l,h=>h,(h,C)=>{var y=vt(),E=g(y,!0);u(y),q(()=>F(E,C)),I(h,y)}),u(m),u(p),I(b,p)};H(a,b=>{l().length>0&&b(d)})}var r=x(a,2);{var i=b=>{var p=yt(),m=x(g(p),2);J(m,20,()=>Object.entries(t()),h=>h,(h,C)=>{const y=_e(()=>{const[U,$]=C;return{impl:U,stats:$}});var E=ft(),T=g(E),M=g(T,!0);u(T);var O=x(T,2),v=g(O),N=g(v);u(v),k(2),u(O);var A=x(O,2),R=g(A),X=g(R,!0);u(R),k(2),u(A);var B=x(A,2),Q=g(B),ee=g(Q);u(Q),k(2),u(B);var re=x(B,2);{var ae=U=>{var $=ht(),f=g($);let L;var G=g(f);u(f),k(2),u($),q(Z=>{L=ue(f,1,"",null,L,{positive:_(y).stats.improvement>0,negative:_(y).stats.improvement<0}),F(G,`${_(y).stats.improvement>0?"+":""}${Z??""}%`)},[()=>D(_(y).stats.improvement,1)]),I(U,$)};H(re,U=>{_(y).impl!=="html"&&_(y).stats.improvement!==void 0&&U(ae)})}u(E),q((U,$,f)=>{F(M,_(y).impl),F(N,`${U??""}ms`),F(X,$),F(ee,`${f??""}%`)},[()=>D(_(y).stats.avg_mean),()=>D(_(y).stats.avg_ops,0),()=>D(_(y).stats.avg_cv*100,1)]),I(h,E)}),u(m),u(p),I(b,p)};H(r,b=>{t()&&b(i)})}var c=x(r,2);{var w=b=>{var p=xt(),m=x(g(p),2),h=g(m),C=g(h);J(C,20,()=>oe,M=>M,(M,O)=>{var v=wt(),N=g(v,!0);u(v),q(()=>F(N,O.header)),I(M,v)}),u(C),u(h);var y=x(h);J(y,20,o,M=>M,(M,O)=>{var v=Mt();J(v,20,()=>oe,N=>N,(N,A)=>{var R=bt(),X=g(R,!0);u(R),q((B,Q)=>{ue(R,1,B),F(X,Q)},[()=>{var B;return Fe(((B=A.class)==null?void 0:B.call(A,O[A.key],O))||"")},()=>A.format(O[A.key],O)]),I(N,R)}),u(v),I(M,v)}),u(y),u(m);var E=x(m,2),T=g(E);{let M=_e(()=>pt(o()));Ke(T,{get text(){return _(M)},children:(O,v)=>{k();var N=Re("copy results as markdown");I(O,N)},$$slots:{default:!0}})}u(E),k(2),u(p),I(b,p)};H(c,b=>{o().length>0&&b(w)})}I(e,s),Y()}const se=()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{e()})})}),fe=async e=>{const n=e+Math.random()*e;await new Promise(o=>setTimeout(o,n)),await se(),await se()};var Nt=P("<div><!></div>");function Rt(e,n){W(n,!0);const o=z(n,"BenchmarkedComponent",3,null),t=z(n,"props",3,null),l=z(n,"on_render_complete",3,()=>{});let s;Se(async()=>{const i=s.querySelector("code"),c=i.getBoundingClientRect(),w=i.offsetHeight;(c.width<=0||w<=0)&&console.error("Unexpected negative dimensions"),await se(),l()()});var a=Nt(),d=g(a);{var r=i=>{var c=K(),w=V(c);Qe(w,o,(b,p)=>{p(b,qe(t))}),I(i,c)};H(d,i=>{o()&&t()&&i(r)})}u(a),he(a,i=>s=i,()=>s),I(e,a),Y()}function St(e,n){W(n,!0);const o=1e4;let t=j(null),l=j(null),s=null,a=j(0);const d=()=>{s&&(s(),s=null)};let r;const i=async(h,C)=>{Ce(a);const y=new Promise((T,M)=>{s=T,r=setTimeout(()=>{s&&(console.error("[Harness] Render timeout after",o,"ms"),s=null,r=void 0,M(new Error(`Render timeout after ${o}ms`)))},o)}),E=performance.now();try{S(t,h,!0),S(l,C,!0),await y,r&&(clearTimeout(r),r=void 0);const M=performance.now()-E;return await se(),M}catch(T){throw console.error("[Harness] Render failed:",T),T}finally{await c()}},c=async()=>{S(t,null),S(l,null),s=null,r&&(clearTimeout(r),r=void 0),await Ie()};var w={run_iteration:i,cleanup:c},b=K(),p=V(b);{var m=h=>{var C=K(),y=V(C);Ve(y,()=>_(a),E=>{Rt(E,{get BenchmarkedComponent(){return _(t)},get props(){return _(l)},on_render_complete:d})}),I(h,C)};H(p,h=>{_(t)&&_(l)&&h(m)})}return I(e,b),Y(w)}const It=5,ye=5,we=.9,be=2,ge={high_lag:200,memory_pressure:500,high_jitter:300,unknown:300},Ct=e=>{if(e.length<It)return 0;const n=e.slice(-10),o=n.reduce((s,a)=>s+a,0)/n.length,t=n.reduce((s,a)=>s+(a-o)**2,0)/n.length;return Math.sqrt(t)/o},Ot=async e=>{const n=performance.now();await new Promise(a=>setTimeout(a,0));const o=performance.now()-n;let t=0;typeof performance<"u"&&performance.memory&&(t=performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit);const l=Ct(e);return{is_stable:o<ye&&t<we&&l<be,lag:o,memory_pressure:t,jitter:l}},At=e=>e.lag>ye?"high_lag":e.jitter>be?"high_jitter":e.memory_pressure&&e.memory_pressure>we?"memory_pressure":"unknown",Pt=async e=>{console.log(`System instability: ${e}, waiting...`),await new Promise(n=>setTimeout(n,ge[e]||ge.unknown))},Lt=(e,n)=>Object.values(e).find(o=>o.lang===n&&o.name.includes("complex")),Ft=(e,n,o)=>{const t=new Map;for(const l of n){const s=Lt(e,l);if(!s)continue;const a=s.content.repeat(o);t.set(l,a);const d=(new TextEncoder().encode(a).length/1024).toFixed(1);console.log(`[Fixtures] Pre-generated ${l}: ${d}KB (${o}x)`)}return t},Me=[{name:"html",component:Xe,mode:null},{name:"ranges",component:$e,mode:"ranges"}],xe=["ts","css","html","json","svelte","md"],Dt=.01,jt=6e4,Ht=.1,Bt=.2,Ut=async(e,n,o,t,l,s)=>{for(let a=0;a<t;a++){const d={content:n,lang:o};e.mode!==null&&(d.mode=e.mode),await s.run_iteration(e.component,d),await fe(l)}},$t=async(e,n,o,t,l,s,a,d)=>{const r=[],i=[],c=[];for(let w=0;w<t.iterations;w++){if(d!=null&&d()){console.log("[Measurement] Stopped by user");break}console.log(`[Measurement] Iteration ${w+1}/${t.iterations}`),await fe(t.cooldown_ms);const b=await Ot(l);if(i.push(b),!b.is_stable){const m=At(b);console.log(`[Measurement] System unstable: ${m}, extended cooldown...`),await Pt(m)}const p={content:n,lang:o};e.mode!==null&&(p.mode=e.mode),console.log(`[Measurement] Running iteration ${w+1}...`);try{const m=await s.run_iteration(e.component,p);m<=0?(console.warn(`[Measurement] Suspicious timing (${m}ms) - marking as failed`),r.push(NaN),c.push(Date.now())):m<Dt?(console.warn(`[Measurement] Suspiciously fast timing (${m}ms) - possible no-op render`),r.push(m),c.push(Date.now()),l.push(m)):m>jt?(console.warn(`[Measurement] Extremely slow timing (${m}ms) - possible hang`),r.push(NaN),c.push(Date.now())):(console.log(`[Measurement] Iteration ${w+1} complete: ${m.toFixed(2)}ms`),r.push(m),c.push(Date.now()),l.push(m))}catch(m){console.error(`[Measurement] Iteration ${w+1} failed:`,m),r.push(NaN),c.push(Date.now())}a&&a(),globalThis.gc&&globalThis.gc()}return{times:r,stability_checks:i,timestamps:c}},zt=async(e,n,o,t,l,s)=>{var y,E,T;const a=Me,d=xe,r=[],i=[],c=[],b=a.length*d.length*n.iterations;let p=0;console.log(`[Runner] Pre-generating large content (${n.content_multiplier}x)...`);const m=Ft(e,d,n.content_multiplier);console.log("[Runner] Pre-generation complete");for(const M of d){if((y=t==null?void 0:t.should_stop)!=null&&y.call(t)){console.log("[Runner] Benchmark stopped by user");break}const O=m.get(M);if(!O){i.push(`No complex sample found for ${M}`);continue}for(const v of a){if((E=t==null?void 0:t.should_stop)!=null&&E.call(t)){console.log("[Runner] Benchmark stopped by user");break}const N=`${v.name} / ${M}`;console.log(`
[Runner] Starting test: ${N}`),t!=null&&t.on_test_start&&t.on_test_start(N);try{await Ut(v,O,M,n.warmup_count,n.cooldown_ms,o);const A=await $t(v,O,M,n,c,o,()=>{p++,t!=null&&t.on_progress&&t.on_progress(p,b)},t==null?void 0:t.should_stop),R=_t(A);console.log(`[Runner] ${N} complete - mean: ${R.mean.toFixed(2)}ms, ops/sec: ${R.ops_per_second.toFixed(2)}`),R.failed_iterations>0&&i.push(`${N}: ${R.failed_iterations} failed iterations`),R.mean<Ht&&i.push(`${N}: Suspiciously fast mean time (${R.mean.toFixed(3)}ms)`),R.outlier_ratio>Bt&&i.push(`${N}: High outlier ratio (${(R.outlier_ratio*100).toFixed(1)}%)`),r.push({implementation:v.name,language:M,...R}),t!=null&&t.on_test_complete&&t.on_test_complete()}catch(A){console.error(`Error testing ${v.name}/${M}:`,A),i.push(`Failed: ${v.name}/${M}`)}}}const h=ut(r),C=dt(r);return i.push(...C),(T=t==null?void 0:t.should_stop)!=null&&T.call(t)&&i.push("Benchmark was stopped by user"),await o.cleanup(),{results:r,warnings:i,summary:h}};var kt=P('<button type="button" class="mt_lg">stop benchmark</button>'),qt=P('<section class="panel"><h3>Progress</h3> <div class="progress-info"><div>Testing: <strong> </strong></div> <div> </div></div> <progress></progress></section>'),Vt=P('<div class="box width_upto_lg mx_auto"><h1 class="mt_xl5">benchmark</h1> <p><code class="font_weight_400 font_size_sm">chromium --js-flags="--expose-gc"</code></p> <section class="panel p_lg"><form><fieldset><legend>config</legend> <label><div class="title">iterations</div> <input type="number" min="10"/></label> <label><div class="title">content multiplier</div> <input type="number" min="50"/></label> <label><div class="title">warmup runs</div> <input type="number" min="3"/></label> <label><div class="title">cooldown (ms)</div> <input type="number" min="10"/></label></fieldset> <button type="button"> </button> <!></form></section> <!> <!> <hr/></div> <!>',1);function on(e,n){W(n,!0);const o=Oe({iterations:10,warmup_count:3,cooldown_ms:100,content_multiplier:20});let t=j(!1),l=j(""),s=j(0),a=j(0),d=j(!1),r=j(null),i;const c=async()=>{if(!i)throw Error();if(!_(t)){S(t,!0),S(d,!1),S(l,""),S(s,0),S(r,{results:[],warnings:[],summary:null}),S(a,Me.length*xe.length*o.iterations);try{S(r,await zt(ze,o,i,{on_progress:(f,L)=>{S(s,f,!0),S(a,L,!0)},on_test_start:f=>{S(l,f,!0)},should_stop:()=>_(d)})),S(l,_(d)?"Stopped":"Complete",!0)}catch(f){console.error("Benchmark failed:",f),_(r).warnings.push(`Fatal error: ${f}`)}finally{S(t,!1)}}},w=()=>{S(d,!0),S(l,"Stopping...")};var b=Vt(),p=V(b),m=x(g(p),4),h=g(m),C=g(h),y=x(g(C),2),E=x(g(y),2);te(E),u(y);var T=x(y,2),M=x(g(T),2);te(M),u(T);var O=x(T,2),v=x(g(O),2);te(v),u(O);var N=x(O,2),A=x(g(N),2);te(A),u(N),u(C);var R=x(C,2);R.__click=c;var X=g(R,!0);u(R);var B=x(R,2);{var Q=f=>{var L=kt();L.__click=w,De(L,"",{},{"margin-left":"1rem"}),I(f,L)};H(B,f=>{_(t)&&f(Q)})}u(h),u(m);var ee=x(m,2);{var re=f=>{var L=qt(),G=x(g(L),2),Z=g(G),le=x(g(Z)),Ee=g(le,!0);u(le),u(Z);var ce=x(Z,2),Te=g(ce);u(ce),u(G);var me=x(G,2);u(L),q(()=>{F(Ee,_(l)),F(Te,`Progress: ${_(s)??""} / ${_(a)??""}`),je(me,_(s)),He(me,"max",_(a))}),I(f,L)};H(ee,f=>{_(t)&&f(re)})}var ae=x(ee,2);{var U=f=>{Tt(f,{get results(){return _(r).results},get summary(){return _(r).summary},get warnings(){return _(r).warnings}})};H(ae,f=>{_(r)&&f(U)})}k(2),u(p);var $=x(p,2);he(St($,{}),f=>i=f,()=>i),q(()=>{E.disabled=_(t),M.disabled=_(t),v.disabled=_(t),A.disabled=_(t),R.disabled=_(t),F(X,_(t)?"running...":"run benchmarks")}),ne(E,()=>o.iterations,f=>o.iterations=f),ne(M,()=>o.content_multiplier,f=>o.content_multiplier=f),ne(v,()=>o.warmup_count,f=>o.warmup_count=f),ne(A,()=>o.cooldown_ms,f=>o.cooldown_ms=f),I(e,b),Y()}Ae(["click"]);export{on as component};
